name: VM Processing Monitor & Data Validation

on:
  workflow_dispatch:
    inputs:
      timestamp:
        description: 'Processing timestamp (YYYYMMDD)'
        required: true
      max_wait_hours:
        description: 'Maximum hours to wait for processing'
        required: false
        default: '8'

env:
  GCP_PROJECT_ID: coms-452404
  GCP_ZONE: us-central1-c
  VM_NAME: dns-whois-fetch-25
  GCP_ACCOUNT: eb3658@columbia.edu

jobs:
  start-vm-processing:
    name: Start VM Processing
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Just for startup verification
    outputs:
      processor_started: ${{ steps.verify.outputs.started }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup GCloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Start VM and trigger processing
        run: |
          TIMESTAMP="${{ github.event.inputs.timestamp }}"

          # Check VM status
          VM_STATUS=$(gcloud compute instances describe ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --format="get(status)")

          if [ "$VM_STATUS" = "TERMINATED" ]; then
            echo "Starting VM..."
            gcloud compute instances start ${{ env.VM_NAME }} --zone=${{ env.GCP_ZONE }}
            echo "Waiting for VM to be ready..."
            sleep 60
          else
            echo "VM is already running (status: $VM_STATUS)"
          fi

          # Download ALL pending batches from GCS to VM (handles backlog automatically)
          echo "Downloading all pending batches from GCS to VM..."
          gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --quiet \
            --command="gcloud storage cp 'gs://phishnet-pipeline-data/queue/batch_*.csv' /home/eeshanbhanap/phishnet/vm_data/url_queue/ 2>/dev/null || echo 'No batches found'"

          echo "Current batch for monitoring: ${TIMESTAMP}"

          # Start processor if not running
          echo "Checking if processor is running..."
          PROCESSOR_RUNNING=$(gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --quiet \
            --command="screen -list | grep -c phishnet || echo 0" 2>&1 | tail -n 1)
          PROCESSOR_RUNNING=${PROCESSOR_RUNNING//[^0-9]/}
          PROCESSOR_RUNNING=${PROCESSOR_RUNNING:-0}

          if [ "$PROCESSOR_RUNNING" -eq "0" ]; then
            echo "Starting VM processor..."
            gcloud compute ssh ${{ env.VM_NAME }} \
              --zone=${{ env.GCP_ZONE }} \
              --quiet \
              --command="cd /home/eeshanbhanap/phishnet && screen -dmS phishnet python3 scripts/vm_daily_processor.py"
            echo "‚úÖ VM processor started"
            sleep 10  # Give processor time to start
          else
            echo "‚úÖ VM processor already running"
          fi

      - name: Verify processor started successfully
        id: verify
        run: |
          TIMESTAMP="${{ github.event.inputs.timestamp }}"

          echo "‚úÖ Verification complete:"
          echo "  - VM is running"
          echo "  - Batch files downloaded to VM queue"
          echo "  - Processor started in screen session"
          echo ""
          echo "üìä Processing will continue in background on VM"
          echo "üìä Current batch: ${TIMESTAMP}"
          echo "üìä Processing takes ~8 hours per batch"
          echo ""
          echo "‚ÑπÔ∏è  Model retraining workflow will verify completion by checking GCS"
          echo "‚ÑπÔ∏è  Processed data will be uploaded to: gs://phishnet-pipeline-data/incremental/"

          # Just verify the processor is running, don't wait for completion
          PROCESSOR_RUNNING=$(gcloud compute ssh ${{ env.VM_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --quiet \
            --command="screen -list | grep -c phishnet || echo 0" 2>&1 | tail -n 1)
          PROCESSOR_RUNNING=${PROCESSOR_RUNNING//[^0-9]/}
          PROCESSOR_RUNNING=${PROCESSOR_RUNNING:-0}

          if [ "$PROCESSOR_RUNNING" -eq "0" ]; then
            echo "‚ùå WARNING: Processor not detected in screen session"
            echo "This may indicate a startup issue. Check VM logs:"
            echo "  gcloud compute ssh ${{ env.VM_NAME }} --zone=${{ env.GCP_ZONE }}"
            echo "  tail -f /home/eeshanbhanap/phishnet/logs/vm_processor_*.log"
            exit 1
          fi

          echo "‚úÖ Processor verified running in screen session 'phishnet'"
          echo "started=true" >> $GITHUB_OUTPUT

          echo ""
          echo "‚ÑπÔ∏è  To check processing status manually:"
          echo "  gcloud compute ssh ${{ env.VM_NAME }} --zone=${{ env.GCP_ZONE }}"
          echo "  screen -r phishnet"
          echo "  (Detach with Ctrl+A then D)"
