name: Deploy API to EC2

# Deploys the FastAPI phishing detection API to EC2
# Runs Docker container with PostgreSQL connection and S3 model sync

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - restart
          - stop
          - status
          - logs

env:
  AWS_REGION: us-east-1
  S3_BUCKET: phishnet-data
  EC2_INSTANCE_ID: i-0c8ab11c281702a22
  API_PORT: 8000

jobs:
  deploy-api:
    name: "Deploy API"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key

      - name: Start EC2 instance
        run: |
          INSTANCE_STATE=$(aws ec2 describe-instances --instance-ids ${{ env.EC2_INSTANCE_ID }} --query 'Reservations[0].Instances[0].State.Name' --output text)
          echo "Current state: $INSTANCE_STATE"

          if [ "$INSTANCE_STATE" = "stopped" ]; then
            echo "Starting EC2 instance..."
            aws ec2 start-instances --instance-ids ${{ env.EC2_INSTANCE_ID }}
            aws ec2 wait instance-running --instance-ids ${{ env.EC2_INSTANCE_ID }}
            echo "Waiting 60s for SSH..."
            sleep 60
          elif [ "$INSTANCE_STATE" = "running" ]; then
            echo "Instance already running"
            sleep 10
          else
            echo "Waiting for instance to be in a stable state..."
            sleep 30
          fi

          EC2_IP=$(aws ec2 describe-instances --instance-ids ${{ env.EC2_INSTANCE_ID }} --query 'Reservations[0].Instances[0].PublicIpAddress' --output text)
          echo "EC2_IP=$EC2_IP" >> $GITHUB_ENV
          echo "EC2 IP: $EC2_IP"

      - name: Open port 8000 in security group
        if: github.event.inputs.action == 'deploy'
        run: |
          # Get security group ID for the instance
          SG_ID=$(aws ec2 describe-instances --instance-ids ${{ env.EC2_INSTANCE_ID }} --query 'Reservations[0].Instances[0].SecurityGroups[0].GroupId' --output text)
          echo "Security Group: $SG_ID"

          # Check if port 8000 is already open
          EXISTING=$(aws ec2 describe-security-groups --group-ids $SG_ID --query "SecurityGroups[0].IpPermissions[?FromPort==\`8000\`]" --output text)

          if [ -z "$EXISTING" ]; then
            echo "Opening port 8000..."
            aws ec2 authorize-security-group-ingress --group-id $SG_ID --protocol tcp --port 8000 --cidr 0.0.0.0/0
            echo "Port 8000 opened"
          else
            echo "Port 8000 already open"
          fi

      - name: Deploy API
        if: github.event.inputs.action == 'deploy'
        run: |
          echo "=============================================="
          echo "DEPLOYING PHISHNET API TO EC2"
          echo "=============================================="

          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ServerAliveInterval=30 \
              -o ServerAliveCountMax=10 \
              -i ~/.ssh/ec2_key ec2-user@${{ env.EC2_IP }} << 'EOFEC2'

          echo "=== Updating code from GitHub ==="
          cd /home/ec2-user

          # Clone if doesn't exist, otherwise pull
          if [ ! -d "phishnet/.git" ]; then
            echo "Cloning repository..."
            rm -rf phishnet
            git clone https://github.com/EpbAiD/phishnet.git
          else
            echo "Updating existing repository..."
            cd phishnet
            git fetch origin main
            git reset --hard origin/main
            cd ..
          fi

          cd phishnet

          echo ""
          echo "=== Installing Docker (if needed) ==="
          if ! command -v docker &> /dev/null; then
            sudo yum update -y
            sudo yum install -y docker
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -aG docker ec2-user
          fi
          sudo systemctl start docker

          echo ""
          echo "=== Stopping existing container and removing old image ==="
          sudo docker stop phishnet-api 2>/dev/null || true
          sudo docker rm phishnet-api 2>/dev/null || true
          sudo docker rmi phishnet-api:latest 2>/dev/null || true
          sudo docker system prune -f 2>/dev/null || true

          echo ""
          echo "=== Building Docker image (fresh, no cache) ==="
          sudo docker build --no-cache --pull -t phishnet-api:latest .

          echo ""
          echo "=== Starting API container ==="
          sudo docker run -d \
            --name phishnet-api \
            --restart unless-stopped \
            -p 8000:8000 \
            -e AWS_REGION=us-east-1 \
            -e S3_BUCKET=phishnet-data \
            -e ENABLE_HOT_RELOAD=true \
            -e MODEL_CHECK_INTERVAL=300 \
            -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            -v /home/ec2-user/phishnet/models:/app/models \
            phishnet-api:latest

          echo ""
          echo "=== Waiting for API to start ==="
          sleep 10

          echo ""
          echo "=== Checking API health ==="
          curl -s http://localhost:8000/health || echo "API not responding yet"

          echo ""
          echo "=== Container status ==="
          sudo docker ps -a | grep phishnet-api

          echo ""
          echo "=============================================="
          echo "API DEPLOYMENT COMPLETE!"
          echo "=============================================="
          EOFEC2

      - name: Restart API
        if: github.event.inputs.action == 'restart'
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/ec2_key ec2-user@${{ env.EC2_IP }} << 'EOFEC2'
          sudo docker restart phishnet-api
          sleep 5
          sudo docker ps | grep phishnet-api
          curl -s http://localhost:8000/health
          EOFEC2

      - name: Stop API
        if: github.event.inputs.action == 'stop'
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/ec2_key ec2-user@${{ env.EC2_IP }} << 'EOFEC2'
          sudo docker stop phishnet-api
          sudo docker ps -a | grep phishnet-api
          EOFEC2

      - name: Check status
        if: github.event.inputs.action == 'status'
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/ec2_key ec2-user@${{ env.EC2_IP }} << 'EOFEC2'
          echo "=== Docker Container Status ==="
          sudo docker ps -a | grep phishnet-api || echo "No API container found"

          echo ""
          echo "=== API Health Check ==="
          curl -s http://localhost:8000/health || echo "API not responding"

          echo ""
          echo "=== Recent API Logs ==="
          sudo docker logs --tail 50 phishnet-api 2>&1 || echo "No logs available"
          EOFEC2

      - name: View logs
        if: github.event.inputs.action == 'logs'
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -i ~/.ssh/ec2_key ec2-user@${{ env.EC2_IP }} << 'EOFEC2'
          echo "=== Last 200 API log lines ==="
          sudo docker logs --tail 200 phishnet-api 2>&1 || echo "No logs available"
          EOFEC2

      - name: Summary
        run: |
          echo ""
          echo "=============================================="
          echo "API ${{ github.event.inputs.action }} COMPLETE"
          echo "=============================================="
          echo ""
          echo "EC2 IP: ${{ env.EC2_IP }}"
          echo "API URL: http://${{ env.EC2_IP }}:8000"
          echo "Health: http://${{ env.EC2_IP }}:8000/health"
          echo "Docs: http://${{ env.EC2_IP }}:8000/docs"
          echo ""
          echo "To check status: Run this workflow with action=status"
          echo "To view logs: Run this workflow with action=logs"
          echo ""
